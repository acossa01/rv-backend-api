<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - VR Oftalmologia</title>
    <link rel="stylesheet" href="style.css">
    <script src="graphql-client.js"></script>
    <style>
        body.register-page {
            background: linear-gradient(180deg, #dbeeff 0%, #f4faff 100%);
        }
        body.register-page::before, body.register-page::after {display:none!important;}

        .register-wrapper{max-width:520px;margin:40px auto;text-align:center;padding:0 10px;}
        .register-logo{display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:24px;}
        .register-logo i{font-size:28px;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .register-logo span{font-size:26px;font-weight:800;color:var(--primary-green);}
        .register-card{background:rgba(255,255,255,0.55);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);padding:40px 48px;border-radius:20px;box-shadow:0 4px 30px rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.6);}
        .register-card h2{background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;margin-bottom:24px;}
        .form-group{margin-bottom:18px;text-align:left;}
        .form-group label{font-weight:700;color:var(--primary-blue);margin-bottom:4px;display:inline-block;background:transparent!important;}
        .form-group input,.form-group select{width:100%;padding:12px 14px;border:2px solid var(--gray-200);border-radius:12px;font-family:var(--font-primary);}
        .form-group input:focus,.form-group select:focus{border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(30,136,229,.15);outline:none;}

        .radio-group{display:flex;gap:20px;margin-bottom:18px;align-items:center;}
        .radio-group input{margin-right:6px;}

        .terms{font-size:14px;margin-top:12px;text-align:left;}
        .terms label{color:#000;font-weight:600;}
        .terms a{color:var(--primary-blue);text-decoration:none;}

        .btn-primary{width:100%;justify-content:center;margin-top:12px;}

        /* Bot√µes Sociais */
        .social-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px 16px;border-radius:50px;font-weight:600;cursor:pointer;transition:var(--transition);margin-bottom:14px;box-shadow:var(--shadow-sm);border:none;}
        .google-btn{background:#ffffff;color:#444;border:1px solid #ddd;}
        .google-btn:hover{box-shadow:var(--shadow-md);} 
        .apple-btn{background:#000000;color:#ffffff;border:1px solid #000000;}
        .apple-btn:hover{background:#1a1a1a;box-shadow:var(--shadow-md);transform:translateY(-1px);}
        .apple-btn i,.apple-btn svg{color:#ffffff !important;fill:#ffffff !important;} 
        .social-btn i{margin-right:6px;font-size:18px;}
    </style>
</head>
<body class="register-page">
    <div class="register-wrapper">
        <div class="register-logo"><i class="fas fa-eye"></i><span>VR Oftalmologia</span></div>
        <div class="register-card">
            <h2>Cadastre seus dados</h2>

            <!-- Bot√µes sociais -->
            <button class="social-btn google-btn" onclick="alert('Cadastro com Google em breve')">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar com Google
            </button>
            <button class="social-btn apple-btn" onclick="alert('Cadastro com Apple em breve')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                </svg>
                Continuar com Apple
            </button>

            <div class="divider" style="display:flex;align-items:center;margin:24px 0;">
                <hr style="flex:1;border:none;border-top:1px solid var(--gray-300);">
                <span style="margin:0 12px;color:var(--gray-600);font-size:14px;font-weight:600;">ou</span>
                <hr style="flex:1;border:none;border-top:1px solid var(--gray-300);">
            </div>
            <form id="register-form" onsubmit="event.preventDefault(); handleRegister(this);">
                <div class="form-group">
                    <label for="reg-name">Nome Completo</label>
                    <input id="reg-name" name="name" type="text" required>
                </div>
                <div class="form-group">
                    <label for="reg-cpf">CPF</label>
                    <input id="reg-cpf" name="cpf" type="text" required>
                </div>
                <div class="form-group">
                    <label for="reg-birth">Data de Nascimento</label>
                    <input id="reg-birth" name="birth" type="date" required>
                </div>
                <div class="form-group">
                    <label for="reg-phone">Telefone / Celular</label>
                    <input id="reg-phone" name="phone" type="tel" required>
                </div>
                <div class="form-group">
                    <label for="reg-email">E-mail</label>
                    <input id="reg-email" name="email" type="email" required>
                </div>
                <div class="form-group">
                    <label for="reg-sex">Sexo</label>
                    <select id="reg-sex" name="sex" required>
                        <option value="" disabled selected>Escolha</option>
                        <option value="feminino">Feminino</option>
                        <option value="masculino">Masculino</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reg-tipo">Tipo de Usu√°rio</label>
                    <select id="reg-tipo" name="tipoUsuario" required>
                        <option value="" disabled selected>Selecione seu perfil</option>
                        <option value="comum">üë§ Usu√°rio Comum</option>
                        <option value="estudante">üéì Estudante</option>
                        <option value="medico">üë®‚Äç‚öïÔ∏è M√©dico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reg-pass">Senha</label>
                    <input id="reg-pass" name="password" type="password" required>
                </div>
                <div class="form-group">
                    <label for="reg-pass2">Repita Sua Senha</label>
                    <input id="reg-pass2" type="password" required>
                </div>
                <div class="terms">
                    <label><input type="checkbox" id="accept" required> Aceito receber comunica√ß√µes da √°rea da sa√∫de.</label>
                </div>
                <button type="submit" class="btn btn-primary">Cadastrar</button>
            </form>
        </div>
    </div>
    <script>
        // Sistema de cadastro com valida√ß√£o completa
        async function handleRegister(form) {
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            try {
                // 1. VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
                const requiredFields = ['name', 'cpf', 'birth', 'phone', 'email', 'sex', 'tipoUsuario', 'password'];
                const missingFields = [];
                
                requiredFields.forEach(fieldName => {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        missingFields.push(getFieldDisplayName(fieldName));
                    }
                });
                
                if (missingFields.length > 0) {
                    showAPINotification(`Por favor, preencha todos os campos obrigat√≥rios: ${missingFields.join(', ')}`, 'error');
                    return;
                }
                
                // 2. VALIDA√á√ÉO DE FORMATO DE EMAIL
                const email = form.querySelector('#reg-email').value.trim();
                if (!isValidEmailFormat(email)) {
                    showAPINotification('Por favor, insira um email com formato v√°lido.', 'error');
                    form.querySelector('#reg-email').focus();
                    return;
                }
                
                // 3. VALIDA√á√ÉO DE SENHAS
                const password = document.getElementById('reg-pass').value;
                const confirmPassword = document.getElementById('reg-pass2').value;
                
                if (password !== confirmPassword) {
                    showAPINotification('As senhas n√£o coincidem! Verifique e tente novamente.', 'error');
                    document.getElementById('reg-pass2').focus();
                    return;
                }
                
                // 4. VALIDA√á√ÉO DE FOR√áA DA SENHA
                if (password.length < 6) {
                    showAPINotification('A senha deve ter pelo menos 6 caracteres.', 'error');
                    document.getElementById('reg-pass').focus();
                    return;
                }
                
                // 5. VALIDA√á√ÉO DE CPF (formato b√°sico)
                const cpf = form.querySelector('#reg-cpf').value.trim();
                if (!isValidCPF(cpf)) {
                    showAPINotification('Por favor, insira um CPF v√°lido (formato: 000.000.000-00).', 'error');
                    form.querySelector('#reg-cpf').focus();
                    return;
                }
                
                // 6. DESABILITAR BOT√ÉO E MOSTRAR LOADING
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
                
                const data = new FormData(form);
                const formData = Object.fromEntries(data);
                
                // 7. PREPARAR DADOS PARA ENVIAR AO BACKEND
                const userData = {
                    nomeCompleto: formData.name,
                    email: formData.email,
                    senha: formData.password,
                    tipoUsuario: formData.tipoUsuario,
                    telefone: formData.phone
                };
                
                // 8. CHAMAR API DE REGISTRO
                const registerResult = await window.graphqlClient.registrar(userData);
                
                // 9. CADASTRO BEM-SUCEDIDO
                submitButton.innerHTML = '<i class="fas fa-check"></i> Cadastrado!';
                
                // Mensagem de sucesso personalizada
                showAPINotification(
                    `‚úÖ Cadastro realizado com sucesso! Bem-vindo(a), ${registerResult.nomeCompleto}!`, 
                    'success'
                );
                
                // Aguardar e mostrar mensagem sobre ambiente Unix
                setTimeout(() => {
                    showAPINotification(
                        'üñ•Ô∏è VOC√ä FOI CADASTRADO MAS O AMBIENTE VIRTUAL UNIX N√ÉO FOI INTEGRADO. TE DAREMOS UM RETORNO EM BREVE!', 
                        'info'
                    );
                    
                    // Redirecionar ap√≥s mostrar a mensagem
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }, 1500);
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                
                // 10. TRATAMENTO ESPEC√çFICO DE ERROS
                let errorMessage = '';
                
                if (error.message.includes('email already exists') || 
                    error.message.includes('j√° existe') ||
                    error.message.includes('duplicate')) {
                    errorMessage = 'Este email j√° possui cadastro no sistema. Deseja fazer login?';
                    
                    // Oferecer redirecionamento para login
                    setTimeout(() => {
                        if (confirm('Email j√° cadastrado. Deseja ir para a tela de login?')) {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                    
                } else if (error.message.includes('network') || 
                          error.message.includes('fetch')) {
                    errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                    
                } else {
                    errorMessage = `Erro no cadastro: ${error.message}`;
                }
                
                showAPINotification(errorMessage, 'error');
                
                // 11. REABILITAR BOT√ÉO
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }
        
        // Fun√ß√£o para obter nome de exibi√ß√£o dos campos
        function getFieldDisplayName(fieldName) {
            const displayNames = {
                'name': 'Nome Completo',
                'cpf': 'CPF',
                'birth': 'Data de Nascimento',
                'phone': 'Telefone',
                'email': 'E-mail',
                'sex': 'Sexo',
                'tipoUsuario': 'Tipo de Usu√°rio',
                'password': 'Senha'
            };
            return displayNames[fieldName] || fieldName;
        }
        
        // Fun√ß√£o para validar formato de email
        function isValidEmailFormat(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Fun√ß√£o para validar CPF (formato b√°sico)
        function isValidCPF(cpf) {
            // Remove caracteres n√£o num√©ricos
            const cleanCPF = cpf.replace(/\D/g, '');
            
            // Verifica se tem 11 d√≠gitos
            if (cleanCPF.length !== 11) return false;
            
            // Verifica se n√£o s√£o todos iguais (ex: 111.111.111-11)
            if (/^(\d)\1{10}$/.test(cleanCPF)) return false;
            
            return true; // Valida√ß√£o b√°sica, pode ser melhorada
        }
        
        // Inicializa√ß√£o e valida√ß√µes em tempo real
        window.addEventListener('DOMContentLoaded', function() {
            // Verificar se usu√°rio j√° est√° logado
            if (window.graphqlClient && window.graphqlClient.isAuthenticated()) {
                showAPINotification('Voc√™ j√° est√° logado! Redirecionando...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // M√°scara para CPF
            const cpfInput = document.querySelector('#reg-cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    this.value = value;
                });
            }
            
            // Valida√ß√£o em tempo real do email
            const emailInput = document.querySelector('#reg-email');
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    const email = this.value.trim();
                    if (email && !isValidEmailFormat(email)) {
                        this.style.borderColor = '#dc2626';
                        showFieldError(this, 'Formato de email inv√°lido');
                    } else {
                        this.style.borderColor = '';
                        clearFieldError(this);
                    }
                });
                
                emailInput.addEventListener('input', function() {
                    clearFieldError(this);
                    this.style.borderColor = '';
                });
            }
            
            // Valida√ß√£o de confirma√ß√£o de senha
            const passwordInput = document.querySelector('#reg-pass');
            const confirmPasswordInput = document.querySelector('#reg-pass2');
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('blur', function() {
                    const password = passwordInput.value;
                    const confirmPassword = this.value;
                    
                    if (confirmPassword && password !== confirmPassword) {
                        this.style.borderColor = '#dc2626';
                        showFieldError(this, 'Senhas n√£o coincidem');
                    } else {
                        this.style.borderColor = '';
                        clearFieldError(this);
                    }
                });
                
                confirmPasswordInput.addEventListener('input', function() {
                    clearFieldError(this);
                    this.style.borderColor = '';
                });
            }
        });
        
        // Fun√ß√µes auxiliares para mostrar/limpar erros de campo
        function showFieldError(field, message) {
            clearFieldError(field);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                color: #dc2626;
                font-size: 12px;
                margin-top: 4px;
                font-weight: 500;
            `;
            field.parentNode.appendChild(errorDiv);
        }
        
        function clearFieldError(field) {
            const errorDiv = field.parentNode.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    </script>
    <script src="https://kit.fontawesome.com/9e9c4f83e2.js" crossorigin="anonymous"></script>
</body>
</html> 